{% extends "pyensemble/diagnostics/base.html" %}
{% load crispy_forms_tags %}

{% block main %}
    <div class="container">
        <div class="h3">Select a study on which to run diagnostics</div>

        <div class="">
            {% crispy form %}
        </div>
    </div>

    <div class="container">
        <div id="results" class="mt-5 overflow-auto sticky-top">

        </div>
    </div>
{% endblock %}

{% block appscript %}
<script>
    function bindData(data){
        // Extract the column labels
        let column_tuples = Object.keys(Object.values(data.experiment_data)[0]); 

        // Build the header
        let level_items = column_tuples.map(function(t){return t.split(",").map(function(d){return d.match(/\b.*\b/)[0]})})

        let num_levels = level_items[0].length;

        // Initialize our levels array
        let levels = [];

        for (let l=0; l<num_levels; l++){
            levels[l] = level_items.map(function(d){return d[l]});
        }

        // Verify the number of levels
        if (num_levels > 1) {
            let counter = {};

            for (item of levels[0]){
                if (counter[item]) {
                    counter[item] += 1;
                } else {
                    counter[item] = 1;
                }
            };

            // Replace levels[0] with the counter data
            levels[0] = [{"key": "index-label", "value": "Subject"}].concat(d3.entries(counter));
        }

        // Create our basic table
        let table = d3.select("#results").append("table").attr("class","diagnostics table table-hover"),
            thead = table.append("thead").attr("class","diagnostics"),
            tbody = table.append("tbody").attr("class","diagnostics");

        // Add the column labels
        thead.selectAll("tr")
            .data(levels)
            .enter()
            .append("tr")
            .selectAll("th")
                .data(function(d){return d;})
                .enter()
                .append("th")
                    .attr("rowspan", function(d){
                        return d.key=="index-label" ? levels.length : 1;
                    })
                    .attr("colspan", function(d){
                        return d.key=="index-label" ? 1 : d.value;
                    })
                    .attr("class", function(d){
                        return d.key=="index-label" ? "freeze-pane index" : "";
                    })
                    .text(function(d){
                        if (d.key=="index-label"){
                            return d.value;
                        } else {
                            return d.key ? d.key:d;
                        }
                    });

        tbody.selectAll("tr")
            .data(d3.entries(data.experiment_data))
            .enter()
            .append("tr")
            .selectAll("td")
                .data(function(d) {
                    return [{"key":"index-label","value":d.key}].concat(d3.entries(d.value));
                }).enter()
                    .append("td")
                        .html(function(d,i) {
                            if (d.key.match(/exclude/)){
                                let val = "<input type='checkbox' class='exclude-checkbox' ";
                                if (d.value=="true") {
                                    val += "checked";
                                }
                                val += ">";
                                return val
                            } else {
                                let val = d.value;
                                if (d.key == "index-label"){
                                    val += "<div class='text-danger'>Exclude <input type='checkbox' class='subject exclude-checkbox'></div>";
                                }
                                return val;
                            }
                        })
                        .attr("class", function(d,i){
                            return i ? "" : "text-primary freeze-pane index";
                        });
    };

    $(function (){
        $(".diagnostics-selector-form").on('submit', function(ev){
            ev.stopImmediatePropagation();
            ev.preventDefault();

            let target = $(".diagnostics-selector-form");

            $.ajax({
                type: target.attr('method'),
                url: target.attr('action'),
                data: target.serialize(),
                success: function(data){
                    data.experiment_data = JSON.parse(data.experiment_data);
                    bindData(data);
                },
                error: function(response,errorText){
                    alert(response.responseText);
                },
            });
        })
    });
</script>
{% endblock %}